generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String       @id @default(cuid())
  firebaseUid         String       @unique
  email               String       @unique
  firstName           String
  lastName            String
  hasPlaidConnection  Boolean      @default(false)
  encryptedPlaidToken String?
  plaidItemId         String?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  twin                Twin?
  shareTokens         ShareToken[]

  @@index([plaidItemId])
  @@map("users")
}

model Twin {
  id                       String       @id @default(cuid())
  userId                   String       @unique
  user                     User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  incomeStabilityScore     Float
  spendingDisciplineScore  Float
  debtTrajectoryScore      Float
  financialResilienceScore Float
  growthMomentumScore      Float
  overallScore             Float

  consumerNarrative        String       @db.Text
  institutionNarrative     String       @db.Text

  personalLoanReadiness    Float
  autoLoanReadiness        Float
  mortgageReadiness        Float
  smallBizReadiness        Float

  profileHash              String
  hederaTopicId            String
  hederaTransactionId      String?
  hederaTimestamp           DateTime?
  blockchainVerified       Boolean      @default(false)

  generatedAt              DateTime     @default(now())
  updatedAt                DateTime     @updatedAt
  transactionCount         Int
  analysisMonths           Int

  transactions             Transaction[]
  shareTokens              ShareToken[]

  @@map("twins")
}

model Transaction {
  id                 String   @id @default(cuid())
  twinId             String
  twin               Twin     @relation(fields: [twinId], references: [id], onDelete: Cascade)
  userId             String
  plaidTransactionId String   @unique
  amount             Float
  date               DateTime
  merchantName       String?
  originalCategory   String[]
  vividCategory      String
  isBusinessExpense  Boolean  @default(false)
  isRecurring        Boolean  @default(false)
  isIncomeDeposit    Boolean  @default(false)
  confidenceScore    Float
  createdAt          DateTime @default(now())

  @@index([twinId])
  @@index([userId])
  @@index([date])
  @@map("transactions")
}

model ShareToken {
  id                     String    @id @default(cuid())
  userId                 String
  user                   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  twinId                 String
  twin                   Twin      @relation(fields: [twinId], references: [id], onDelete: Cascade)
  token                  String    @unique @default(uuid())

  recipientEmail         String?
  recipientInstitution   String?
  recipientName          String?

  showOverallScore       Boolean   @default(true)
  showDimensionScores    Boolean   @default(true)
  showNarrative          Boolean   @default(true)
  showTimeline           Boolean   @default(false)
  showTransactions       Boolean   @default(false)
  showLendingReadiness   Boolean   @default(true)
  showBlockchainProof    Boolean   @default(true)

  expiresAt              DateTime?
  revokedAt              DateTime?
  accessCount            Int       @default(0)
  lastAccessedAt         DateTime?
  createdAt              DateTime  @default(now())

  @@index([token])
  @@index([userId])
  @@map("share_tokens")
}

model Institution {
  id          String          @id @default(cuid())
  name        String
  type        InstitutionType
  email       String          @unique
  firebaseUid String          @unique
  logoUrl     String?
  createdAt   DateTime        @default(now())

  @@map("institutions")
}

enum InstitutionType {
  CREDIT_UNION
  COMMUNITY_BANK
  OTHER
}

model TwinSnapshot {
  id                       String   @id @default(cuid())
  userId                   String
  incomeStabilityScore     Float
  spendingDisciplineScore  Float
  debtTrajectoryScore      Float
  financialResilienceScore Float
  growthMomentumScore      Float
  overallScore             Float
  snapshotAt               DateTime @default(now())

  @@index([userId, snapshotAt])
  @@map("twin_snapshots")
}

model ZkpClaim {
  id                  String    @id @default(cuid())
  userId              String
  twinId              String
  claimType           String
  claimStatement      String
  claimResult         Boolean
  claimHash           String
  proofHash           String    @unique
  hederaTransactionId String?
  hederaTimestamp      DateTime?
  hederaTopicId       String?
  recipientLabel      String?
  expiresAt           DateTime?
  revokedAt           DateTime?
  accessCount         Int       @default(0)
  createdAt           DateTime  @default(now())

  @@index([proofHash])
  @@index([userId])
  @@map("zkp_claims")
}

model VerifiedBadge {
  id              String    @id @default(cuid())
  userId          String
  consentToken    String    @unique @default(uuid())
  label           String?
  allowedScopes   String[]
  expiresAt       DateTime?
  revokedAt       DateTime?
  accessCount     Int       @default(0)
  lastAccessedAt  DateTime?
  createdAt       DateTime  @default(now())

  @@index([consentToken])
  @@index([userId])
  @@map("verified_badges")
}

// ─── Networked Reputation Graph ──────────────────────────────────────────────

model AttestationProvider {
  id              String              @id @default(cuid())
  name            String
  type            AttestationProviderType
  domain          String              @unique
  apiKeyHash      String              @unique
  logoUrl         String?
  verified        Boolean             @default(false)
  contactEmail    String?
  createdAt       DateTime            @default(now())
  attestations    Attestation[]

  @@map("attestation_providers")
}

enum AttestationProviderType {
  EMPLOYER
  LANDLORD
  LENDER
  GIG_PLATFORM
  PAYROLL_PROVIDER
  UTILITY
  GOVERNMENT
  OTHER
}

model Attestation {
  id                  String                @id @default(cuid())
  userId              String
  twinId              String
  providerId          String
  provider            AttestationProvider    @relation(fields: [providerId], references: [id], onDelete: Cascade)
  attestationType     AttestationType
  claim               String
  details             String?               @db.Text
  evidence            String?               @db.Text
  startDate           DateTime?
  endDate             DateTime?
  strength            Int                   @default(50)
  attestationHash     String                @unique
  hederaTransactionId String?
  hederaTimestamp     DateTime?
  hederaTopicId       String?
  revokedAt           DateTime?
  revokedReason       String?
  expiresAt           DateTime?
  verificationCount   Int                   @default(0)
  lastVerifiedAt      DateTime?
  createdAt           DateTime              @default(now())

  @@index([userId])
  @@index([twinId])
  @@index([providerId])
  @@index([attestationHash])
  @@map("attestations")
}

enum AttestationType {
  VERIFIED_INCOME
  ON_TIME_RENT
  EMPLOYMENT_VERIFIED
  GIG_EARNINGS
  LOAN_REPAYMENT
  UTILITY_PAYMENT
  IDENTITY_VERIFIED
  REFERENCE
  CUSTOM
}

// ─── Embedded Vivid Widget ───────────────────────────────────────────────────

model WidgetConfig {
  id                String          @id @default(cuid())
  partnerId         String
  partnerName       String
  partnerDomain     String
  apiKeyHash        String          @unique
  template          WidgetTemplate
  allowedOrigins    String[]
  brandColor        String          @default("#8b5cf6")
  logoUrl           String?
  scopes            String[]
  callbackUrl       String?
  webhookUrl        String?
  active            Boolean         @default(true)
  totalSessions     Int             @default(0)
  totalConversions  Int             @default(0)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  sessions          WidgetSession[]

  @@index([apiKeyHash])
  @@index([partnerId])
  @@map("widget_configs")
}

enum WidgetTemplate {
  LENDING
  RENTAL
  GIG_HIRING
  CHECKOUT
  GENERIC
}

model WidgetSession {
  id              String              @id @default(cuid())
  widgetId        String
  widget          WidgetConfig        @relation(fields: [widgetId], references: [id], onDelete: Cascade)
  userId          String?
  sessionToken    String              @unique @default(uuid())
  status          WidgetSessionStatus @default(PENDING)
  consentedScopes String[]
  resultData      String?             @db.Text
  origin          String?
  userAgent       String?
  ipHash          String?
  expiresAt       DateTime
  completedAt     DateTime?
  createdAt       DateTime            @default(now())

  @@index([sessionToken])
  @@index([widgetId])
  @@index([userId])
  @@map("widget_sessions")
}

enum WidgetSessionStatus {
  PENDING
  CONSENTED
  COMPLETED
  EXPIRED
  DENIED
}
